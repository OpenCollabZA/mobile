'use strict';
var LearningUnitsViewSectionCtrl = ($scope, $q, $compile, $rootScope, $routeParams, SynthQLoop, LearningUnitsService, ResourcesService, SynthErrorHandler) => {
	$rootScope.activePage = 'learning_units';

	$scope.moduleId = $routeParams.moduleId;
	$scope.sectionId = $routeParams.sectionId;
	$scope.unitId = $routeParams.unitId;

	$('[ng-iscroll=mainScroll] .scroller').css('width', 'auto');

	/**
	 * Function to find the current, next, and previous
	 * sections
	 */
	function findCurrentNextPrevious(sections){
		for(var idx = 0 ; idx < sections.length; idx++){
			if(sections[idx].id == $scope.sectionId){
				$scope.section = sections[idx];

				// Get the next if there is more
				if(idx + 1 < sections.length){
					$scope.nextSection = sections[idx + 1];
				}

				// Get the previous if there is less
				if (idx - 1 >= 0){
					$scope.previousSection = sections[idx - 1];
				}
				break;
			}
		}
	}

	// Get all the sections of the unit
	LearningUnitsService
	.getSections($routeParams.moduleId, $routeParams.unitId, true)
	.then(function(sections) {
		findCurrentNextPrevious(sections);
	}, SynthErrorHandler);


	// Get the unit to update the breadcrumb
	LearningUnitsService
	.getSection($routeParams.moduleId, $scope.unitId)
	.then(function(unit) {
		$rootScope.breadcrumbs = [{'name' : 'Learning Units', 'url' : '#/tool/learning_units/' + $routeParams.moduleId},
		{'name' : unit.title, 'url' : '#/tool/learning_units/' + $routeParams.moduleId + '/' + $scope.unitId}];
	}, SynthErrorHandler);


	function fixAndDisplaySection(section){
		var contentElement = angular.element('<div>');
		contentElement.append(section.content);

		contentElement.find('[data-resource-id]').each(function() {
			// Create the directive element from the image
			var imageHolder = $(this);
			var templateElement = angular.element('<resource-img />');
			templateElement.attr('data-resource-id', imageHolder.attr('data-resource-id'));
			templateElement.attr('data-src', imageHolder.attr('data-src'));
			templateElement.attr('data-width', imageHolder.attr('width'));
			templateElement.attr('data-height', imageHolder.attr('height'));

			// Compile the directive and replace the element in the DOM
			var newElement = $compile(templateElement)($scope);
			imageHolder.replaceWith(newElement);
		});
		$('#sectionContent').replaceWith(contentElement);
	}

	// Get the current section
	LearningUnitsService
	.getSection($routeParams.moduleId, $routeParams.sectionId)
	.then(function(section) {
		fixAndDisplaySection(section);
	}, SynthErrorHandler);

	$scope.$on('$destroy', function() {
		$('[ng-iscroll=mainScroll] .scroller').css('width', '');
	});

};
LearningUnitsViewSectionCtrl.$inject = ['$scope', '$q', '$compile', '$rootScope', '$routeParams', 'SynthQLoop', 'LearningUnitsService', 'ResourcesService', 'SynthErrorHandler'];
export default LearningUnitsViewSectionCtrl;
